<!-- log file -->
<script type="text/x-red" data-template-name="patlamp">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>
	<div class="form-row">
		<label for="node-input-mapFilePath"><i class="icon-tag"></i> MAP file</label>
		<input type="text" id="node-input-mapFilePath" placeholder="please input file path of map file">
	</div>
	<div class="form-row">
		<label for="node-input-reportInterval"><i class="fa fa-clock-o"></i> Report</label>
		<input type="text" id="node-input-reportInterval" placeholder="report interval" style = "width:80px;">
		<label for="node-input-reportIntervalUnit"></i>sec</label>
	</div>
	<div class="form-row">
		<label for="node-input-detectInterval"><i class="fa fa-clock-o"></i> Detect</label>
		<input type="text" id="node-input-detectInterval" placeholder="detect interval" style = "width:80px;">
		<label for="node-input-reportIntervalUnit"></i>msec</label>
	</div>
</script>

<script type="text/x-red" data-help-name="patlamp">
	<p>A simple node that converts the message payloads into all lower-case characters</p>
</script>

<script type="text/javascript">
	RED.nodes.registerType("patlamp",{
		category: 'function',
		color: '#a6bbcf',
		defaults: {
			name: {value:""},
			mapFilePath: {
				value:"",
				required: true
			},
			reportInterval: {value: 10,
				validate:RED.validators.number(),
				required:true
			},
			detectInterval: {value: 500,
				validate:RED.validators.number(),
				required:true
			}
		},
		inputs:0,
		outputs:1,
		icon: "file.png",
		label: function() {
			return this.name||"patlamp";
		},
		button: {
			toggle: "active",
			onclick: function() {
				var label = this.name||"patlamp";
				var node = this;
				$.ajax({
					url: "patlamp/"+this.id+"/"+(this.active?"enable":"disable"),
					type: "POST",
					success: function(resp, textStatus, xhr) {
						console.log("success");
						if (xhr.status == 200) {
							RED.notify(node._("activated",{label:label}),"success");
						} else if (xhr.status == 201) {
							RED.notify(node._("deactivated",{label:label}),"success");
						}
					},
					error: function(jqXHR,textStatus,errorThrown) {
						if (jqXHtlstatus == 404) {
							RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.not-deployed")}),"error");
						} else if (jqXHR.status == 0) {
							RED.notify(node._("common.notification.error", {message: node._("common.notification.errors.no-response")}),"error");
						} else {
							RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:err.status,message:err.response})}),"error");
						}
					}
				});
			}
		},
		onpaletteadd: function() {
			var options = {
				messageMouseEnter: function(sourceId) {
					if (sourceId) {
						var n = RED.nodes.node(sourceId);
						if (n) {
							n.highlighted = true;
							n.dirty = true;
						}
						RED.view.redraw();
					}
				},
				messageMouseLeave: function(sourceId) {
					if (sourceId) {
						var n = RED.nodes.node(sourceId);
						if (n) {
							n.highlighted = false;
							n.dirty = true;
						}
						RED.view.redraw();
					}
				},
				messageSourceClick: function(sourceId) {
					RED.view.reveal(sourceId);
				},
				clear: function() {
					RED.nodes.eachNode(function(node) {
						node.highlighted = false;
						node.dirty = true;
					});
					RED.view.redraw();
				}
			}
			var uiComponents = RED.debug.init(options);
			RED.sidebar.addTab({
				id: "debug",
				label: this._("debug.sidebar.label"),
				name: this._("debug.sidebar.name"),
				content: uiComponents.content,
				toolbar: uiComponents.footer,
				enableOnEdit: true
			});
			RED.actions.add("core:show-debug-tab",function() {
				RED.sidebar.show('debug');
			});
			var that = this;
			RED._debug = function(msg) {
				console.log(msg);
				that.handleDebugMessage("",{
					name:"patlamp",
					msg:msg
				});
			},
			this.handleWindowMessage = function(evt) {
				var msg = evt.data;
				console.log(msg);
				if (msg.event === "mouseEnter") {
					options.messageMouseEnter(msg.id);
				} else if (msg.event === "mouseLeave") {
					options.messageMouseLeave(msg.id);
				} else if (msg.event === "mouseClick") {
					options.messageSourceClick(msg.id);
				} else if (msg.event === "clear") {
					options.clear();
				}
			}
			window.addEventListener('message',this.handleWindowMessage);
		},
		onpaletteremove: function() {
			RED.comms.unsubscribe("debug",this.handleDebugMessage);
			RED.sidebar.removeTab("debug");
			RED.events.off("workspace:change", this.refreshMessageList);
			window.removeEventListener("message",this.handleWindowMessage);
			RED.actions.remove("core:show-debug");
			delete RED._debug;
		}
	});
</script>

